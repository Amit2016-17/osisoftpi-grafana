{"version":3,"sources":["../src/datasource.js"],"names":["angular","_","PiWebApiDatasource","instanceSettings","backendSrv","templateSrv","$q","$cacheFactory","webidCache","get","type","url","toString","piwebapiurl","jsonData","isProxy","test","access","name","piserver","webid","afserver","afdatabase","getAssetServer","then","result","WebId","getDataServer","getDatabase","annotationOptions","endTime","eventFrame","attributeDataItems","regex","enable","Name","replace","RegExp","search","attributeText","each","attributeData","attributeValue","Value","annotation","title","showEndTime","time","Date","EndTime","StartTime","getTime","text","options","targets","filter","target","startsWith","map","tar","elementPath","scopedVars","attributes","att","display","refId","hide","interpolate","recordedValues","webids","expression","summary","types","startTime","range","from","toJSON","to","undefined","item","ds","query","buildQueryParameters","t","length","when","data","all","getStream","flattened","targetResponses","tr","push","sort","a","b","variableExists","datasourceRequest","method","response","status","message","categoryName","nameFilter","templateName","template","datasource","iconColor","attribute","resourceUrl","join","restBatch","Content","valueData","annotations","Items","index","curry","eventFrameToAnnotation","ends","end","restGet","expandable","HasChildren","Path","split","fromJson","querydepth","path","Math","max","min","getAssetServers","metricQueryTransform","getDatabases","server","getDatabaseElements","db","selectedFields","getElement","getElements","element","getAttributes","searchFullHierarchy","interval","basis","batchQuery","batchIndex","hasAttributes","elementBatchId","encodeURIComponent","value","isSummary","api","datapoints","previousValue","grafanaDataPoint","parsePiPointValue","drop","noDataReplace","nodata","num","Number","isNaN","Timestamp","noDataReplacementMode","Good","content","innerResults","groups","groupBy","Type","forOwn","key","parsePiPointValueList","results","isInterpolated","intervalTime","timeRange","targetName","restGetWebId","restPost","webidresponse","processResults","catch","error","err","maxDataPoints","getSummaryUrl","maxNumber","targetResults","targetResult","headers","assetPath","cachedWebId","indexOf","put","batch","serverId","databaseId","InstanceType","elementId","querystring","isAf","isAttribute","piPointSearch"],"mappings":"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","file":"datasource.js","sourceRoot":"gridprotectionalliance-osisoftpi-datasource","sourcesContent":["import angular from 'angular'\nimport _ from 'lodash'\n\n\nexport class PiWebApiDatasource {\n  /**\n   * Creates an instance of PiWebApiDatasource.\n   * \n   * @param {any} instanceSettings - Settings from admin page.\n   * @param {any} backendSrv - Grafana backend web communications.\n   * @param {any} templateSrv - Grafana template server.\n   * @param {any} $q - Angular async/promise helper.\n   * @param {any} $cacheFactory - A cache for PI Web API webids for element paths.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  constructor (instanceSettings, backendSrv, templateSrv, $q, $cacheFactory) {\n    this.$q = $q\n    this.backendSrv = backendSrv\n    this.templateSrv = templateSrv\n    this.webidCache = $cacheFactory.get('piWebApiIds') || $cacheFactory('piWebApiIds')\n\n    this.type = instanceSettings.type\n    this.url = instanceSettings.url.toString()\n    this.piwebapiurl = instanceSettings.jsonData.url.toString()\n    this.isProxy = /^http(s)?:\\/\\//.test(this.url) || instanceSettings.jsonData.access === 'proxy';\n\n    this.name = instanceSettings.name\n    this.piserver = {name: (instanceSettings.jsonData || {}).piserver, webid: null}\n    this.afserver = {name: (instanceSettings.jsonData || {}).afserver, webid: null}\n    this.afdatabase = {name: (instanceSettings.jsonData || {}).afdatabase, webid: null}\n\n    this.getAssetServer(this.afserver.name).then(result => { this.afserver.webid = result.WebId })\n    this.getDataServer(this.piserver.name).then(result => { this.piserver.webid = result.WebId })\n    this.getDatabase(this.afserver.name + '\\\\' + this.afdatabase.name).then(result => { this.afdatabase.webid = result.WebId })\n  }\n\n  /**\n   * Converts a PIWebAPI Event Frame response to a Grafana Annotation\n   * \n   * @param {any} annotationOptions - Options data from configuration panel.\n   * @param {any} endTime - End time of the Event Frame.\n   * @param {any} eventFrame - The Event Frame data.\n   * @returns - Grafana Annotation\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  eventFrameToAnnotation (annotationOptions, endTime, eventFrame, attributeDataItems) {\n    if (annotationOptions.regex && annotationOptions.regex.enable) {\n      eventFrame.Name = eventFrame.Name.replace(new RegExp(annotationOptions.regex.search), annotationOptions.regex.replace)\n    }\n\n    var attributeText = ''\n    if (attributeDataItems) {\n      _.each(attributeDataItems, (attributeData) => {\n        const attributeValue = attributeData.Value.Value ? attributeData.Value.Value.Name || attributeData.Value.Value.Value || attributeData.Value.Value : null\n        attributeText += ('<br />' + attributeData.Name + ': ' + attributeValue)\n      })\n    }\n    return {\n      annotation: annotationOptions,\n      title: (endTime ? 'END ' : annotationOptions.showEndTime ? 'START ' : '') + annotationOptions.name,\n      time: new Date(endTime ? eventFrame.EndTime : eventFrame.StartTime).getTime(),\n      text: eventFrame.Name +\n            attributeText +\n            '<br />Start: ' + eventFrame.StartTime +\n            '<br />End: ' + eventFrame.EndTime\n      // tags: eventFrame.CategoryNames.join()\n    }\n  }\n\n  /**\n   * Builds the PIWebAPI query parameters.\n   * \n   * @param {any} options - Grafana query and panel options.\n   * @returns - PIWebAPI query parameters.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  buildQueryParameters (options) {\n    options.targets = _.filter(options.targets, target => {\n      return (!target.target.startsWith('Select AF'))\n    })\n\n    options.targets = _.map(options.targets, target => {\n      var tar = {\n        target: this.templateSrv.replace(target.elementPath, options.scopedVars),\n        elementPath: this.templateSrv.replace(target.elementPath, options.scopedVars),\n        attributes: _.map(target.attributes, att => { return this.templateSrv.replace(att) }),\n        display: target.display,\n        refId: target.refId,\n        hide: target.hide,\n        interpolate: target.interpolate || {enable: false},\n        recordedValues: target.recordedValues || {enable: false},\n        webid: target.webid,\n        webids: target.webids || [],\n        regex: target.regex || {enable: false},\n        expression: target.expression || '',\n        summary: target.summary || {types: []},\n        startTime: options.range.from.toJSON(),\n        endTime: options.range.to.toJSON()\n      }\n      \n      if (tar.expression) {\n        tar.expression = this.templateSrv.replace(tar.expression);\n      }\n\n      if (tar.summary.types !== undefined) {\n        tar.summary.types = _.filter(tar.summary.types, item => { return item !== undefined && item !== null && item !== '' })\n      }\n\n      return tar\n    })\n\n    return options\n  }\n\n  /**\n   * Datasource Implementation. Primary entry point for data source.\n   * This takes the panel configuration and queries, sends them to PI Web API and parses the response.\n   * \n   * @param {any} options - Grafana query and panel options.\n   * @returns - Promise of data in the format for Grafana panels.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  query (options) {\n    var ds = this\n\n    var query = this.buildQueryParameters(options)\n    query.targets = _.filter(query.targets, t => !t.hide)\n\n    if (query.targets.length <= 0) {\n      return this.$q.when({data: []})\n    } else {\n      return ds.$q.all(\n        ds.getStream(query))\n        .then(targetResponses => {\n          var flattened = []\n          _.each(targetResponses, tr => {\n            _.each(tr, item => {\n              flattened.push(item)\n            })\n          })\n          return {data: flattened.sort((a, b) => { return +(a.target > b.target) || +(a.target === b.target) - 1 })}\n        })\n    }\n  }\n\n  /**\n   * Alerting Implementation\n   * \n   * @param {any} target\n   * @returns - boolean alert status\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  targetContainsTemplate(target) {\n    return this.templateSrv.variableExists(target.target);\n  }\n  \n  /**\n   * Datasource Implementation. \n   * Used for testing datasource in datasource configuration pange\n   * \n   * @returns - Success or failure message.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  testDatasource () {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: 'success', message: 'Data source is working', title: 'Success' }\n      }\n    })\n  }\n\n  /**\n   * Datasource Implementation. \n   * This queries PI Web API for Event Frames and converts them into annotations.\n   * \n   * @param {any} options - Annotation options, usually the Event Frame Category.\n   * @returns - A Grafana annotation.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  annotationQuery (options) {\n    if (!this.afdatabase.webid) {\n      return this.$q.when([])\n    } \n\n    var categoryName = options.annotation.query.categoryName ? this.templateSrv.replace(options.annotation.query.categoryName, {}, 'glob') : null\n    var nameFilter = options.annotation.query.nameFilter ? this.templateSrv.replace(options.annotation.query.nameFilter, {}, 'glob') : null\n    var templateName = options.annotation.template ? options.annotation.template.Name : null\n    var annotationOptions = {\n      name: options.annotation.name,\n      datasource: options.annotation.datasource,\n      enable: options.annotation.enable,\n      iconColor: options.annotation.iconColor,\n      showEndTime: options.annotation.showEndTime,\n      regex: options.annotation.regex,\n      attribute: options.annotation.attribute,\n      categoryName: categoryName,\n      templateName: templateName,\n      nameFilter: nameFilter\n    }\n\n    var filter = []\n    if (!!annotationOptions.categoryName) {\n      filter.push('categoryName=' + annotationOptions.categoryName)\n    }\n    if (!!annotationOptions.nameFilter) {\n      filter.push('nameFilter=' + annotationOptions.nameFilter)\n    }\n    if (!!annotationOptions.templateName) {\n      filter.push('templateName=' + annotationOptions.templateName)\n    }\n    if (!filter.length) {\n      return this.$q.when([])\n    }\n    filter.push('startTime=' + options.range.from.toJSON())\n    filter.push('endTime=' + options.range.to.toJSON())\n\n    if (annotationOptions.attribute && annotationOptions.attribute.enable) {\n      var resourceUrl = this.piwebapiurl +'/streamsets/{0}/value?selectedFields=Items.WebId;Items.Value;Items.Name'\n      if (!!annotationOptions.attribute.name) {\n        resourceUrl = this.piwebapiurl +'/streamsets/{0}/value?nameFilter=' + annotationOptions.attribute.name + '&selectedFields=Items.WebId;Items.Value;Items.Name'\n      }\n      var query = {}\n      query[\"1\"] = {\n        'Method': 'GET',\n        'Resource': this.piwebapiurl +'/assetdatabases/' + this.afdatabase.webid + '/eventframes?' + filter.join('&')\n      },\n      query[\"2\"] = {\n        'Method': 'GET',\n        'RequestTemplate': {\n          'Resource': resourceUrl,\n        },\n        'Parameters': [\n            '$.1.Content.Items[*].WebId'\n        ],\n        'ParentIds': [\n            '1'\n        ]\n      }\n      return this.restBatch(query).then((result) => {\n        const data = result.data[\"1\"].Content\n        const valueData = result.data[\"2\"].Content\n\n        var annotations = _.map(data.Items, (item, index) => {\n          return _.curry(this.eventFrameToAnnotation)(annotationOptions, false, item, valueData.Items[index].Content.Items)\n        })\n  \n        if (options.annotation.showEndTime) {\n          var ends = _.map(data.Items, (item, index) => {\n            return _.curry(this.eventFrameToAnnotation)(annotationOptions, true, item, valueData.Items[index].Content.Items)\n          })\n          _.each(ends, end => { annotations.push(end) })\n        }\n  \n        return annotations\n      })\n    } else {\n      return this.restGet('/assetdatabases/' + this.afdatabase.webid + '/eventframes?' + filter.join('&')).then(result => {\n        var annotations = _.map(result.data.Items, _.curry(this.eventFrameToAnnotation)(annotationOptions, false))\n  \n        if (options.annotation.showEndTime) {\n          var ends = _.map(result.data.Items, _.curry(this.eventFrameToAnnotation)(annotationOptions, true))\n          _.each(ends, end => { annotations.push(end) })\n        }\n  \n        return annotations\n      })\n    }\n  }\n\n  /**\n   * Builds the Grafana metric segment for use on the query user interface.\n   * \n   * @param {any} response - response from PI Web API.\n   * @returns - Grafana metric segment.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  metricQueryTransform (response) {\n    return _.map(response, item => {\n      return {\n        text: item.Name,\n        expandable: (item.HasChildren === undefined || item.HasChildren === true || item.Path.split('\\\\').length <= 3),\n        Path: item.Path,\n        WebId: item.WebId\n      }\n    })\n  }\n\n  /**\n   * This method does the discovery of the AF Hierarchy and populates the query user interface segments.\n   * \n   * @param {any} query - Parses the query configuration and builds a PI Web API query.\n   * @returns - Segment information.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  metricFindQuery (query) {\n    query = angular.fromJson(query)\n\n    var ds = this\n    var querydepth = ['servers', 'databases', 'databaseElements', 'elements']\n    if (query.path === '') {\n      query.type = querydepth[0]\n    } else if (query.type !== 'attributes') {\n      query.type = querydepth[Math.max(0, Math.min(query.path.split('\\\\').length, querydepth.length - 1))]\n    }\n\n    query.path = this.templateSrv.replace(query.path)\n\n    if (query.type === 'servers') {\n      return ds.getAssetServers()\n        .then(ds.metricQueryTransform)\n    } else if (query.type === 'databases') {\n      return ds.getAssetServer(query.path)\n        .then(server => {\n          return ds.getDatabases(server.WebId, {})\n            .then(ds.metricQueryTransform) })\n    } else if (query.type === 'databaseElements') {\n      return ds.getDatabase(query.path)\n        .then(db => {\n          return ds.getDatabaseElements(db.WebId, {selectedFields: 'Items.WebId;Items.Name;Items.Path;Item.HasChildren'})\n            .then(ds.metricQueryTransform) })\n    } else if (query.type === 'elements') {\n      return ds.getElement(query.path)\n        .then(element => {\n          return ds.getElements(element.WebId, {selectedFields: 'Items.WebId;Items.Name;Items.Path;Item.HasChildren'})\n            .then(ds.metricQueryTransform) })\n    } else if (query.type === 'attributes') {\n      return ds.getElement(query.path)\n        .then(element => {\n          return ds.getAttributes(element.WebId, {searchFullHierarchy: 'true', selectedFields: 'Items.WebId;Items.Name;Items.Path'})\n            .then(ds.metricQueryTransform) })\n    }\n  }\n\n  /**\n   * Gets the url of summary data from the query configuration.\n   * \n   * @param {any} summary - Query summary configuration.\n   * @returns - URL append string.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  getSummaryUrl (summary) {\n    if (summary.interval == \"\") {\n      return '&summaryType=' + summary.types.join('&summaryType=') +\n            '&calculationBasis=' + summary.basis\n    }\n    return '&summaryType=' + summary.types.join('&summaryType=') +\n            '&calculationBasis=' + summary.basis +\n            '&summaryDuration=' + summary.interval\n  }\n\n  /**\n   * Resolve a Grafana query into a PI Web API webid. Uses client side cache when possible to reduce lookups.\n   * \n   * @param {any} query - Grafana query configuration.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  resolveWebIds (query) {\n    var ds = this\n    var batchQuery = {}\n    var batchIndex = 1\n\n    _.each(query.targets, target => {\n      var hasAttributes = target.attributes.length > 0\n\n      var elementBatchId = batchIndex++\n      batchQuery[elementBatchId.toString()] = {\n        'Method': 'GET',\n        'Resource': '/elements?selectedFields=WebId;Name;Path&path=\\\\\\\\' + encodeURIComponent(target.elementPath)\n      }\n\n      if (hasAttributes) {\n        _.each(target.attributes, attribute => {\n          batchQuery[(batchIndex++).toString()] = {\n            'Method': 'GET',\n            'Resource': '/elements/{0}/attributes?selectedFields=WebId;Name;Path&nameFilter=' + encodeURIComponent(target.elementPath),\n            'Parameters': [\n              '$.' + elementBatchId + '.Content.WebId'\n            ],\n            'ParentIds': [\n              elementBatchId.toString()\n            ]\n          }\n        })\n      } else {\n   \n      }\n      target.attributes\n    })\n  }\n\n  /**\n   * Resolve PIWebAPI response 'value' data to value - timestamp pairs.\n   * \n   * @param {any} value - A list of PIWebAPI values.\n   * @param {any} target - The target Grafana metric.\n   * @param {any} isSummary - Boolean for tracking if data is of summary class.\n   * @returns - An array of Grafana value, timestamp pairs.\n   * \n   */\n  parsePiPointValueList(value, target, isSummary = false) {\n    var api = this;\n    var datapoints = [];\n    var previousValue = null;\n    _.each(value, item => {\n      var grafanaDataPoint = api.parsePiPointValue(item, isSummary, target);\n      var drop = false;\n      if (isSummary){\n        grafanaDataPoint, previousValue, drop = this.noDataReplace(item.Value, target.summary.nodata, grafanaDataPoint)\n      } else{\n        grafanaDataPoint, previousValue, drop = this.noDataReplace(item, target.summary.nodata, grafanaDataPoint)\n      }\n      if (!drop) {\n        datapoints.push(grafanaDataPoint)\n      }\n    })\n    return datapoints;\n  }\n  \n  /**\n   * Convert a PI Point value to use Grafana value/timestamp.\n   * \n   * @param {any} value - PI Point value.\n   * @param {any} isSummary - Boolean for tracking if data is of summary class.\n   * @param {any} target - The target grafana metric.\n   * @returns - Grafana value pair.\n   * \n   */\n  parsePiPointValue (value, isSummary = false, target) {\n    var num = (!isSummary && typeof value.Value === \"object\") ? Number(value.Value.Value) : Number(value.Value)\n    if (isSummary) {\n      num = Number(value.Value.Value)\n      if (target.summary.interval == \"\"){\n        return [(!isNaN(num) ? num : 0), new Date(target.endTime).getTime()]\n      }\n      return [(!isNaN(num) ? num : 0), new Date(value.Value.Timestamp).getTime()]\n    }    \n    return [(!isNaN(num) ? num : 0), new Date(value.Timestamp).getTime()]\n  }\n\n  /**\n   * Resolve PIWebAPI response 'value' data to value - timestamp pairs.\n   * \n   * @param {any} item - 'Item' object from PIWebAPI\n   * @param {any} noDataReplacementMode - String state of how to replace 'No Data'\n   * @param {any} grafanaDataPoint - Single Grafana value pair (value, timestamp).\n   * @returns grafanaDataPoint - Single Grafana value pair (value, timestamp).\n   * @returns perviousValue - {any} Grafana value (value only). \n   * \n   */\n  noDataReplace(item, noDataReplacementMode, grafanaDataPoint){\n    var previousValue = null;\n    var drop = false;\n    if (item.Value === 'No Data' || (item.Value.Name && item.Value.Name === 'No Data') || !item.Good) {\n      if (noDataReplacementMode === 'Drop') {\n        drop = true;\n      } else if (noDataReplacementMode === '0') {\n        grafanaDataPoint[0] = 0;\n      } else if (noDataReplacementMode === 'Null') {\n        grafanaDataPoint[0] = null;\n      } else if (noDataReplacementMode === 'Previous' && previousValue !== null) {\n        grafanaDataPoint[0] = previousValue;\n      }\n    } else {\n      previousValue = item.Value;\n    }\n    return grafanaDataPoint, previousValue, drop\n  }\n\n  /**\n   * Process the response from PI Web API for a single item.\n   * \n   * @param {any} content - Web response data.\n   * @param {any} target - The target grafana metric.\n   * @param {any} name - The target metric name.\n   * @returns - Parsed metric in target/datapoint json format.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  processResults (content, target, name) {\n    var api = this\n    var isSummary = target.summary && target.summary.types && target.summary.types.length > 0\n    if (target.regex && target.regex.enable) {\n      name = name.replace(new RegExp(target.regex.search), target.regex.replace)\n    }\n    if (isSummary) {\n      var innerResults = []\n      var groups = _.groupBy(content.Items, item => { return item.Type })\n      _.forOwn(groups, (value, key) => {\n        innerResults.push({\n          'target': name + '[' + key + ']',\n          'datapoints': api.parsePiPointValueList(value, target, isSummary)\n        })\n      })\n      return innerResults\n    }\n    return [{\n      'target': name,\n      'datapoints': api.parsePiPointValueList(content.Items, target, isSummary)\n    }]\n    // }).catch(err => { api.error = err }))\n  }\n\n  /**\n   * Gets historical data from a PI Web API stream source.\n   * \n   * @param {any} query - Grafana query.\n   * @returns - Metric data.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  getStream (query) {\n    var api = this\n    var results = []\n\n    _.each(query.targets, target => {\n      target.attributes = _.filter(target.attributes || [], attribute => { return (1 && attribute) })\n      var url = ''\n      var isSummary = target.summary && target.summary.types && target.summary.types.length > 0\n      var isInterpolated = target.interpolate && target.interpolate.enable\n      // perhaps add a check to see if interpolate override time < query.interval\n      var intervalTime = ((target.interpolate.interval) ? target.interpolate.interval : query.interval)\n      var timeRange = '?startTime=' + query.range.from.toJSON() + '&endTime=' + query.range.to.toJSON()\n      var targetName = target.expression || target.elementPath\n      if (target.expression) {\n        url += '/calculation'\n        if (isSummary) {\n          url += '/summary' + timeRange + (isInterpolated ? '&sampleType=Interval&sampleInterval=' + intervalTime : '')\n        } else {\n          url += '/intervals' + timeRange + '&sampleInterval=' + intervalTime\n        }\n        url += '&expression=' + encodeURIComponent(target.expression)\n        url += '&webid='\n        if (target.attributes.length > 0) {\n          _.each(target.attributes, attribute => {\n            results.push(\n              api.restGetWebId(target.elementPath + '|' + attribute)\n              .then(webidresponse => {\n                return api.restPost(url + webidresponse.WebId)\n                .then(response => { return api.processResults(response.data, target, target.display || attribute || targetName) })\n                .catch(err => { api.error = err })\n              }))\n          })\n        } else {\n          results.push(\n            api.restGetWebId(target.elementPath)\n              .then(webidresponse => {\n                return api.restPost(url + webidresponse.WebId)\n                .then(response => { return api.processResults(response.data, target, target.display || targetName) })\n                .catch(err => { api.error = err })\n              }))\n        }\n\n      } else {\n        url += '/streamsets'\n        if (isSummary) {\n          url += '/summary' + timeRange + '&intervals=' + query.maxDataPoints + this.getSummaryUrl(target.summary)\n        } else if (target.interpolate && target.interpolate.enable) {\n          url += '/interpolated' + timeRange + '&interval=' + intervalTime\n        } else if (target.recordedValues && target.recordedValues.enable) {\n          url += '/recorded' + timeRange + '&maxCount=' + target.recordedValues.maxNumber\n        } else {\n          url += '/plot' + timeRange + '&intervals=' + query.maxDataPoints\n        }\n\n        results.push(api.$q.all(_.map(target.attributes, attribute => { return api.restGetWebId(target.elementPath + '|' + attribute) }))\n        .then(webidresponse => {\n          var query = {};\n          _.each(webidresponse, function(webid, index) {\n            query[index + 1] = {\n              \"Method\": \"GET\",\n              \"Resource\": api.piwebapiurl + url + '&webid=' + webid.WebId\n            }\n          });\n\n          return api.restBatch(query)\n            .then(response => {\n              var targetResults = []\n              _.each(response.data, (value, key) => {\n                _.each(value.Content.Items, item => {\n                  _.each(api.processResults(item, target, target.display || item.Name || targetName), targetResult => { targetResults.push(targetResult) })\n                })\n              })\n              \n              return targetResults\n            })\n            .catch(err => { api.error = err })\n        }))\n      }\n    })\n\n    return results\n  }\n\n  /**\n   * Abstraction for calling the PI Web API REST endpoint\n   * \n   * @param {any} path - the path to append to the base server URL.\n   * @returns - The full URL.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  restGet (path) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + path,\n      method: 'GET',\n      headers: { 'Content-Type': 'application/json' }\n    })\n  }\n\n  /**\n   * Resolve a Grafana query into a PI Web API webid. Uses client side cache when possible to reduce lookups.\n   * \n   * @param {any} assetPath - The AF Path to the asset.\n   * @returns - URL query parameters.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  restGetWebId (assetPath) {\n    var ds = this\n\n    // check cache\n    var cachedWebId = ds.webidCache.get(assetPath)\n    if (cachedWebId) {\n      return ds.$q.when({Path: assetPath, WebId: cachedWebId})\n    }\n\n    // no cache hit, query server\n    var path = ((assetPath.indexOf('|') >= 0)\n                ? '/attributes?selectedFields=WebId;Name;Path&path=\\\\\\\\'\n                : '/elements?selectedFields=WebId;Name;Path&path=\\\\\\\\') +\n                assetPath\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + path,\n      method: 'GET',\n      headers: { 'Content-Type': 'application/json' }\n    }).then(response => {\n      ds.webidCache.put(assetPath, response.data.WebId)\n      return { Path: assetPath, WebId: response.data.WebId }\n    })\n  }\n\n  /**\n   * Execute a batch query on the PI Web API.\n   * \n   * @param {any} batch - Batch JSON query data.\n   * @returns - Batch response.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  restBatch (batch) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/batch',\n      data: batch,\n      method: 'POST',\n      headers: { \n        'Content-Type': 'application/json',\n        'X-Requested-With': 'message/http'\n      }\n    })\n  }\n\n  /**\n   * Execute a POST on the PI Web API.\n   * \n   * @param {any} path - The full url of the POST.\n   * @returns - POST response data.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  restPost (path) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Requested-With': 'message/http',\n        'X-PIWEBAPI-HTTP-METHOD': 'GET',\n        'X-PIWEBAPI-RESOURCE-ADDRESS': path\n      }\n    })\n  }\n\n  // Get a list of all data (PI) servers\n  getDataServers () {\n    return this.restGet('/dataservers')\n    .then(response => { return response.data.Items })\n  }\n  getDataServer (name) {\n    return this.restGet('/dataservers?name=' + name)\n    .then(response => { return response.data })\n  }\n  // Get a list of all asset (AF) servers\n  getAssetServers () {\n    return this.restGet('/assetservers')\n      .then(response => { return response.data.Items })\n  }\n  getAssetServer (name) {\n    return this.restGet('/assetservers?path=\\\\\\\\' + name)\n      .then(response => { return response.data })\n  }\n  getDatabase (path) {\n    return this.restGet('/assetdatabases?path=\\\\\\\\' + path)\n      .then(response => { return response.data })\n  }\n  getDatabases (serverId, options) {\n    return this.restGet('/assetservers/' + serverId + '/assetdatabases')\n      .then(response => { return response.data.Items })\n  }\n  getElement (path) {\n    return this.restGet('/elements?path=\\\\\\\\' + path)\n      .then(response => { return (response.data) })\n  }\n  getEventFrameTemplates (databaseId) {\n    return this.restGet('/assetdatabases/' + databaseId + '/elementtemplates?selectedFields=Items.InstanceType;Items.Name;Items.WebId')\n      .then(response => {\n        return _.filter(response.data.Items, item => {\n          return item.InstanceType === 'EventFrame'\n        })\n      })\n  }\n  getElementTemplates (databaseId) {\n    return this.restGet('/assetdatabases/' + databaseId + '/elementtemplates?selectedFields=Items.InstanceType;Items.Name;Items.WebId')\n      .then(response => {\n        return _.filter(response.data.Items, item => {\n          return item.InstanceType === 'Element'\n        })\n      })\n  }\n\n  /**\n   * @description\n   * Get the child attributes of the current resource.\n   * GET attributes/{webId}/attributes\n   * @param {string} elementId - The ID of the parent resource. See WebID for more information.\n   * @param {Object} options - Query Options\n   * @param {string} options.nameFilter - The name query string used for finding attributes. The default is no filter. See Query String for more information.\n   * @param {string} options.categoryName - Specify that returned attributes must have this category. The default is no category filter.\n   * @param {string} options.templateName - Specify that returned attributes must be members of this template. The default is no template filter.\n   * @param {string} options.valueType - Specify that returned attributes' value type must be the given value type. The default is no value type filter.\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include attributes nested further than the immediate attributes of the searchRoot. The default is 'false'.\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\n   * @param {string} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\n   * @param {string} options.showExcluded - Specified if the search should include attributes with the Excluded property set. The default is 'false'.\n   * @param {string} options.showHidden - Specified if the search should include attributes with the Hidden property set. The default is 'false'.\n   * @param {string} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\n   * @param {string} options.selectedFields - List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\n   */\n  getAttributes (elementId, options) {\n    var querystring = '?' + _.map(options, function (value, key) {\n      return key + '=' + value\n    }).join('&')\n\n    if (querystring === '?') { querystring = '' }\n\n    return this.restGet('/elements/' + elementId + '/attributes' + querystring)\n      .then(response => { return response.data.Items })\n  }\n\n  /**\n   * @description\n   * Retrieve elements based on the specified conditions. By default, this method selects immediate children of the current resource.\n   * Users can search for the elements based on specific search parameters. If no parameters are specified in the search, the default values for each parameter will be used and will return the elements that match the default search.\n   * GET assetdatabases/{webId}/elements\n   * @param {string} databaseId - The ID of the parent resource. See WebID for more information.\n   * @param {Object} options - Query Options\n   * @param {string} options.webId - The ID of the resource to use as the root of the search. See WebID for more information.\n   * @param {string} options.nameFilter - The name query string used for finding objects. The default is no filter. See Query String for more information.\n   * @param {string} options.categoryName - Specify that returned elements must have this category. The default is no category filter.\n   * @param {string} options.templateName - Specify that returned elements must have this template or a template derived from this template. The default is no template filter.\n   * @param {string} options.elementType - Specify that returned elements must have this type. The default type is 'Any'. See Element Type for more information.\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include objects nested further than the immediate children of the searchRoot. The default is 'false'.\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\n   * @param {number} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\n   * @param {number} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\n   * @param {string} options.selectedFields -  List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\n   */\n  getDatabaseElements (databaseId, options) {\n    var querystring = '?' + _.map(options, function (value, key) {\n      return key + '=' + value\n    }).join('&')\n\n    if (querystring === '?') { querystring = '' }\n\n    return this.restGet('/assetdatabases/' + databaseId + '/elements' + querystring)\n      .then(response => { return response.data.Items })\n  }\n\n  /**\n   * @description\n   * Retrieve elements based on the specified conditions. By default, this method selects immediate children of the current resource.\n   * Users can search for the elements based on specific search parameters. If no parameters are specified in the search, the default values for each parameter will be used and will return the elements that match the default search.\n   * GET elements/{webId}/elements\n   * @param {string} databaseId - The ID of the resource to use as the root of the search. See WebID for more information.\n   * @param {Object} options - Query Options\n   * @param {string} options.webId - The ID of the resource to use as the root of the search. See WebID for more information.\n   * @param {string} options.nameFilter - The name query string used for finding objects. The default is no filter. See Query String for more information.\n   * @param {string} options.categoryName - Specify that returned elements must have this category. The default is no category filter.\n   * @param {string} options.templateName - Specify that returned elements must have this template or a template derived from this template. The default is no template filter.\n   * @param {string} options.elementType - Specify that returned elements must have this type. The default type is 'Any'. See Element Type for more information.\n   * @param {string} options.searchFullHierarchy - Specifies if the search should include objects nested further than the immediate children of the searchRoot. The default is 'false'.\n   * @param {string} options.sortField - The field or property of the object used to sort the returned collection. The default is 'Name'.\n   * @param {string} options.sortOrder - The order that the returned collection is sorted. The default is 'Ascending'.\n   * @param {number} options.startIndex - The starting index (zero based) of the items to be returned. The default is 0.\n   * @param {number} options.maxCount - The maximum number of objects to be returned per call (page size). The default is 1000.\n   * @param {string} options.selectedFields -  List of fields to be returned in the response, separated by semicolons (;). If this parameter is not specified, all available fields will be returned. See Selected Fields for more information.\n   */\n  getElements (elementId, options) {\n    var querystring = '?' + _.map(options, function (value, key) {\n      return key + '=' + value\n    }).join('&')\n\n    if (querystring === '?') { querystring = '' }\n\n    return this.restGet('/elements/' + elementId + '/elements' + querystring)\n    .then(response => { return response.data.Items })\n  }\n\n  /**\n   * Retrieve a list of points on a specified Data Server.\n   * \n   * @param {string} serverId - The ID of the server. See WebID for more information.\n   * @param {string} nameFilter - A query string for filtering by point name. The default is no filter. *, ?, [ab], [!ab]\n   */\n  piPointSearch (serverId, nameFilter) {\n    return this.restGet('/dataservers/' + serverId + '/points?maxCount=100&nameFilter=' + nameFilter).then(results => {\n      return results.data.Items\n    })\n  }\n\n  /**\n   * Get the PI Web API webid or PI Point.\n   * \n   * @param {any} target - AF Path or Point name.\n   * @returns - webid.\n   * \n   * @memberOf PiWebApiDatasource\n   */\n  getWebId (target) {\n    var api = this\n\n    var isAf = target.target.indexOf('\\\\') >= 0\n    var isAttribute = target.target.indexOf('|') >= 0\n    if (!isAf && target.target.indexOf('.') === -1) { return api.$q.when([{ WebId: target.target, Name: target.display || target.target }]) }\n\n\n    if (!isAf) {\n      // pi point lookup\n      return api.piPointSearch(this.piserver.webid, target.target).then(results => {\n        if (results.data.Items === undefined || results.data.Items.length === 0) {\n          return [{ WebId: target.target, Name: target.display || target.target }]\n        }\n        return results.data.Items\n      })\n    } else if (isAf && isAttribute) {\n      // af attribute lookup\n      return api.restGet('/attributes?path=\\\\\\\\' + target.target).then(results => {\n        if (results.data === undefined || results.status !== 200) {\n          return [{ WebId: target.target, Name: target.display || target.target }]\n        }\n        // rewrite name if specified\n        results.data.Name = target.display || results.data.Name\n        return [results.data]\n      })\n    } else {\n      // af element lookup\n      return api.restGet('/elements?path=\\\\\\\\' + target.target).then(results => {\n        if (results.data === undefined || results.status !== 200) {\n          return [{ WebId: target.target, Name: target.display || target.target }]\n        }\n        // rewrite name if specified\n        results.data.Name = target.display || results.data.Name\n        return [results.data]\n      })\n    }\n  }\n}\n"]}